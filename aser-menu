#!/usr/bin/env bash
# ğŸ§  aserdev's cursed Rofi Control Center ğŸ’€
# deps: rofi, wl-clipboard, notify-send, kitty (optional), braincells (optional)

set -euo pipefail
IFS=$'\n\t'

TERMINAL="${TERMINAL:-kitty}"
EDITOR="${EDITOR:-nano}"
ROFI_CMD="${ROFI_CMD:-rofi -dmenu -i -p}"

# ğŸ’¬ Discord launcher
run_discord() {
  if command -v discord &>/dev/null; then
    echo "ğŸ’¬ launching discordâ€¦ hope ur friends are online"
    discord &
  else
    ask_install discord && discord &
  fi
}

# âœ… Yes/No menu with attitude
rofi_yn() {
  local prompt="${1:-Proceed?}"
  local ans
  ans=$(printf 'Yes\nNo' | rofi -dmenu -p "$prompt (pls don't break anything)")
  [[ "$ans" == "Yes" ]]
}

# ğŸ”§ install helper, passive-aggressive edition
ask_install() {
  local pkg="$1"
  local bin="${2:-$1}"
  if ! command -v "$bin" &>/dev/null; then
    if rofi_yn "Install $pkg?"; then
      if command -v ins &>/dev/null; then
        echo "ğŸ“¦ installing $pkgâ€¦ fingers crossed ğŸ’€"
        ins "$pkg"
      else
        rofi -e "No install command found. Fix ur life, install $pkg manually."
        return 1
      fi
    else
      echo "ğŸ™„ skipped installing $pkgâ€¦ brave choice"
      return 1
    fi
  fi
  return 0
}

# ğŸ“ Open files/folders, with fallback chaos
open_in_thunar() {
  local path="${1:-$HOME}"
  if ! command -v thunar &>/dev/null; then
    ask_install thunar || xdg-open "$path" >/dev/null 2>&1 || $TERMINAL -e "$EDITOR" "$path"
  else
    thunar "$path" &
  fi
}

open_file_gui_or_terminal() {
  local file="$1"
  if command -v pluma &>/dev/null; then
    pluma "$file" &
  else
    $TERMINAL -e bash -c "$EDITOR '$file'; read -p 'Press enter to escape this madnessâ€¦'"
  fi
}

# ğŸ“¦ Install Menu, chaotic edition
install_menu() {
  local MENU=$(printf "ğŸ“¦ update-os\nğŸ“¦install-package\nâ¬…ï¸ Back" | rofi -dmenu -p "Install Packages:")
  case "$MENU" in
    "ğŸ“¦ update-os")
      echo "âš¡ updating the osâ€¦ may break something, pray ğŸ’€"
      if command -v install &>/dev/null; then
        $TERMINAL -e bash -c "update; read -p 'Press enter to surviveâ€¦'"
      else
        ask_install aserdev-os-utils install && $TERMINAL -e bash -c "update; read -p 'Press enterâ€¦'"
      fi
      ;;
    "ğŸ“¦install-package")
      local pkg_name
      pkg_name=$(rofi -dmenu -p "Enter package name to throw into system:")
      [[ -n "$pkg_name" ]] && $TERMINAL -e bash -c "ins '$pkg_name'; read -p 'Press enterâ€¦'"
      ;;
    "â¬…ï¸ Back") main_menu ;;
  esac
}

# ğŸ“‹ Clipboard menu, passive-aggressive edition
clipboard_menu() {
  local options=("ğŸ“‹  Open Clipboard" "ğŸ§¹  Clear Clipboard" "â¬…ï¸  Back")
  local choice=$(printf '%s\n' "${options[@]}" | rofi -dmenu -i -p "Clipboard (don't f*** it up)")
  case "$choice" in
    "ğŸ“‹  Open Clipboard") ask_install aserdev-os-utils rofi-cliphist && rofi-cliphist ;;
    "ğŸ§¹  Clear Clipboard") ask_install aserdev-os-utils cliphist && cliphist wipe && notify-send "Clipboard" "Cleared ğŸ’€" || rofi -e "No cliphist, rip" ;;
    "â¬…ï¸  Back") main_menu ;;
  esac
}

# ğŸ§  System info menu
sysinfo_menu() {
  local options=("ğŸ§   Brokefetch" "âš¡  Fastfetch" "ğŸ“Š  Btop" "â¬…ï¸  Back")
  local choice=$(printf '%s\n' "${options[@]}" | rofi -dmenu -i -p "System Info (stare at ur stats)")
  case "$choice" in
    "ğŸ§   Brokefetch")
      command -v brokefetch &>/dev/null && $TERMINAL -e bash -c "brokefetch; read -p 'Press enter to exitâ€¦'" || ask_install brokefetch ;;
    "âš¡  Fastfetch") ask_install fastfetch && $TERMINAL -e bash -c "fastfetch; read -p 'Press enterâ€¦'" ;;
    "ğŸ“Š  Btop") ask_install btop && $TERMINAL -e btop ;;
    "â¬…ï¸  Back") main_menu ;;
  esac
}

# âŒ Kill window, brutal edition
kill_window() {
  if command -v hyprctl &>/dev/null; then
    echo "ğŸ’€ killing active windowâ€¦"
    hyprctl dispatch killactive ""
  elif command -v xkill &>/dev/null; then
    xkill
    notify-send "Kill Window" "Click the window you wanna destroy ğŸ’€"
  else
    rofi -e "No window kill tool found. Ur on ur own."
  fi
}

# ğŸŒ Web search menu
web_search() {
  local HIST_FILE="$HOME/.cache/web_search_history"
  local ENGINES=("Google|https://www.google.com/search?q=" "DuckDuckGo|https://duckduckgo.com/?q=" "ArchWiki|https://wiki.archlinux.org/index.php?search=")
  command -v jq &>/dev/null || ask_install jq || { rofi -e "jq required for URL encoding ğŸ’€"; return 1; }
  
  urlencode() { jq -rn --arg v "$1" '$v|@uri'; }

  local engine_choice engine_name engine_url
  engine_choice=$(printf "%s\n" "${ENGINES[@]%%|*}" | rofi -dmenu -p "ğŸŒ Pick engine (don't die):")
  [[ -z "$engine_choice" ]] && return

  for e in "${ENGINES[@]}"; do
    engine_name="${e%%|*}"
    engine_url="${e#*|}"
    [[ "$engine_name" == "$engine_choice" ]] && break
  done

  mkdir -p "$(dirname "$HIST_FILE")"
  touch "$HIST_FILE"
  local query
  query=$(tac "$HIST_FILE" | rofi -dmenu -p "ğŸ” Search:" -mesg "Engine: $engine_name")
  [[ -z "$query" ]] && return
  grep -Fxq "$query" "$HIST_FILE" || echo "$query" >> "$HIST_FILE"

  local encoded_query
  encoded_query=$(urlencode "$query")
  echo "ğŸŒ opening $engine_name for: $query"
  xdg-open "${engine_url}${encoded_query}" &>/dev/null &
}

# ğŸ”” Notifications toggle
swaync_client() {
  ask_install swaync swaync-client && swaync-client -t
}

# ğŸ–• Main cursed menu
main_menu() {
  local options=("âš™ï¸  Settings" "ğŸš€  Run Command" "ğŸŒ  Web Search" "ğŸ””  Notifications" "ğŸ“¦  Install" "ğŸ“‹  Clipboard" "ğŸ˜€  Emoji Picker" "ğŸ“¸  Screen capture" "âŒ  Kill Window" "ğŸ’¬  discord" "ğŸ§   System Info" "ğŸ”‹  Power" "â„¹ï¸  About")
  local choice=$(printf '%s\n' "${options[@]}" | rofi -dmenu -i -p "Aser Control Center (chaos edition)")
  case "$choice" in
    "âš™ï¸  Settings") aser-settings ;;
    "ğŸš€  Run Command") rofi -show run ;;
    "ğŸŒ  Web Search") web_search ;;
    "ğŸ””  Notifications") swaync_client ;;
    "ğŸ“¦  Install") install_menu ;;
    "ğŸ“‹  Clipboard") clipboard_menu ;;
    "ğŸ˜€  Emoji Picker") rofi -show emoji ;;
    "ğŸ“¸  Screen capture") ask_install aserdev-os-utils screenrec && screenrec ;;
    "âŒ  Kill Window") kill_window ;;
    "ğŸ’¬  discord") run_discord ;;
    "ğŸ§   System Info") sysinfo_menu ;;
    "ğŸ”‹  Power") aser-power ;;
    "â„¹ï¸  About") xdg-open "https://github.com/aserdevyt/aserdev-os/" ;;
    *) echo "ğŸ™„ canceled or invalidâ€¦ exiting"; exit 0 ;;
  esac
}

main_menu
