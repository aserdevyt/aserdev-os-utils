#!/usr/bin/env bash
# ğŸ§  aserdev's Rofi Control Center â€” Simplified with Screenrec Integration
# Minimal deps: rofi, notify-send, wl-clipboard, a terminal (kitty preferred)
set -euo pipefail
IFS=$'\n\t'

TERMINAL="${TERMINAL:-kitty}"
EDITOR="${EDITOR:-nano}"
ROFI_CMD="${ROFI_CMD:-rofi -dmenu -i -p}"

run_discord() {
  if command -v discord &>/dev/null; then
    discord &
  else
    ask_install discord && discord &
  fi
}

rofi_yn() {
  local prompt="${1:-Proceed?}"
  local ans
  ans=$(printf 'Yes\nNo' | rofi -dmenu -p "$prompt")
  [[ "$ans" == "Yes" ]]
}

ask_install() {
  # Usage: ask_install <package_name> [binary_name]
  local pkg="$1"
  local bin="${2:-$1}"
  if ! command -v "$bin" &>/dev/null; then
    if rofi_yn "Install $pkg?"; then
      if command -v ins &>/dev/null; then
        ins "$pkg"
      else
        rofi -e "No install command found. Please install $pkg manually."
        return 1
      fi
    else
      return 1
    fi
  fi
  return 0
}

open_in_thunar() {
  local path="${1:-$HOME}"
  if ! command -v thunar &>/dev/null; then
    ask_install thunar || xdg-open "$path" >/dev/null 2>&1 || $TERMINAL -e "$EDITOR" "$path"
  else
    thunar "$path" &
  fi
}

open_file_gui_or_terminal() {
  local file="$1"
  if command -v pluma &>/dev/null; then
    pluma "$file" &
  else
    # MODIFIED: Switched back to 'bash -c'
    $TERMINAL -e bash -c "$EDITOR '$file'; read -p 'Press enter to exit...'"
  fi
}



install_menu() {
local MENU=$(printf "ğŸ“¦ update-os\nğŸ“¦install-package\nâ¬…ï¸ Back" | rofi -dmenu -p "Install Packages:")
case "$MENU" in
    "ğŸ“¦ update-os")
      if command -v install &>/dev/null; then
          $TERMINAL -e bash -c "update; read -p 'Press enter to exit...'"
      else
          ask_install aserdev-os-utils install && $TERMINAL -e bash -c "update; read -p 'Press enter to exit...'"
      fi
        ;;
    "ğŸ“¦install-package")
        local pkg_name
        pkg_name=$(rofi -dmenu -p "Enter package name to install:")
        if [[ -n "$pkg_name" ]]; then
            $TERMINAL -e bash -c "ins '$pkg_name'; read -p 'Press enter to exit...'"
        fi
        ;;
    "â¬…ï¸ Back")
        main_menu
        ;;
    *)
        ;;
esac
}

clipboard_menu() {
  local options=("ğŸ“‹  Open Clipboard" "ğŸ§¹  Clear Clipboard" "â¬…ï¸  Back")
  local choice=$(printf '%s\n' "${options[@]}" | rofi -dmenu -i -p "Clipboard")
  case "$choice" in
    "ğŸ“‹  Open Clipboard") ask_install aserdev-os-utils rofi-cliphist && rofi-cliphist ;;
    "ğŸ§¹  Clear Clipboard") ask_install aserdev-os-utils cliphist && cliphist wipe && notify-send "Clipboard" "Cleared" || rofi -e "No cliphist" ;;
    "â¬…ï¸  Back") main_menu ;;
  esac
}

sysinfo_menu() {
  local options=("ğŸ§   Brokefetch" "âš¡  Fastfetch" "ğŸ“Š  Btop" "â¬…ï¸  Back")
  local choice=$(printf '%s\n' "${options[@]}" | rofi -dmenu -i -p "System Info")
  case "$choice" in
    # MODIFIED: Switched back to bash -c
    "ğŸ§   Brokefetch")
        command -v brokefetch &>/dev/null && $TERMINAL -e bash -c "brokefetch; read -p 'Press enter to exit...'" || ask_install brokefetch ;;
    # MODIFIED: Switched back to bash -c
    "âš¡  Fastfetch")
        ask_install fastfetch && $TERMINAL -e bash -c "fastfetch; read -p 'Press enter to exit...'" ;;
    "ğŸ“Š  Btop")
        # btop is interactive, so it should exit cleanly after the user quits it. No need for a read-p.
        ask_install btop && $TERMINAL -e btop ;;
    "â¬…ï¸  Back") main_menu ;;
  esac
}

kill_window() {
  # Use hyprctl to kill the active window for Wayland/Hyprland
  if command -v hyprctl &>/dev/null; then
    hyprctl dispatch killactive ""
  # Fallback to xkill for general X11 environments
  elif command -v xkill &>/dev/null; then
    xkill
    notify-send "Kill Window" "Click the window you want to close."
  else
    rofi -e "No window kill tool (hyprctl or xkill) found."
  fi
}

web_search() {
  local HIST_FILE="$HOME/.cache/web_search_history"
  local ENGINES=(
    "Google|https://www.google.com/search?q="
    "Bing|https://www.bing.com/search?q="
    "DuckDuckGo|https://duckduckgo.com/?q="
    "Wikipedia|https://en.wikipedia.org/wiki/Special:Search?search="
    "ArchWiki|https://wiki.archlinux.org/index.php?search="
  )

  # ğŸ§  FIX: Using the jq-based urlencode which is robust, and checking for jq availability.
  if ! command -v jq &>/dev/null; then
    if ! ask_install jq; then
        rofi -e "jq is required for robust URL encoding. Please install it."
        return 1
    fi
  fi
  
  # Robust URL encoding function using jq
  urlencode() {
    jq -rn --arg v "$1" '$v|@uri'
  }

  # pick engine ğŸ§ 
  local engine_choice engine_name engine_url
  engine_choice=$(printf "%s\n" "${ENGINES[@]%%|*}" | rofi -dmenu -p "ğŸŒ Choose engine:")
  [[ -z "$engine_choice" ]] && return

  for e in "${ENGINES[@]}"; do
    engine_name="${e%%|*}"
    engine_url="${e#*|}"
    [[ "$engine_name" == "$engine_choice" ]] && break
  done

  # search query (with history ğŸ§ )
  mkdir -p "$(dirname "$HIST_FILE")"
  touch "$HIST_FILE"
  local query
  query=$(tac "$HIST_FILE" | rofi -dmenu -p "ğŸ” Search:" -mesg "Engine: $engine_name (Enter to search, Esc to cancel)")
  [[ -z "$query" ]] && return

  # save to history (no dupes)
  grep -Fxq "$query" "$HIST_FILE" || echo "$query" >> "$HIST_FILE"

  # encode + open ğŸŒ
  local encoded_query
  encoded_query=$(urlencode "$query")
  xdg-open "${engine_url}${encoded_query}" &>/dev/null &
}



swaync_client() {
  # Sway Notification Center client to toggle the notification list
  # Package name is typically 'swaync' but the binary is 'swaync-client'
  ask_install swaync swaync-client && swaync-client -t
}

main_menu() {
  local options=(
    "âš™ï¸  Settings"
    "ğŸš€  Run Command"
    "ğŸŒ  Web Search"
    "ğŸ””  Notifications"
    "ğŸ“¦  Install"
    "ğŸ“‹  Clipboard"
    "ğŸ˜€  Emoji Picker"
    "ğŸ“¸  Screen capture"
    "âŒ  Kill Window"
    "ğŸ’¬  discord"
    "ğŸ§   System Info"
    "ğŸ”‹  Power"
    "â„¹ï¸  About"
  )
  local choice=$(printf '%s\n' "${options[@]}" | rofi -dmenu -i -p "Aser Control Center")
  case "$choice" in
    "âš™ï¸  Settings") aser-settings ;;
    "ğŸš€  Run Command") rofi -show run ;;
    "ğŸŒ  Web Search") web_search ;;
    "ğŸ””  Notifications") swaync_client ;;
    "ğŸ“¦  Install") install_menu ;;
    "ğŸ“‹  Clipboard") clipboard_menu ;;
    "ğŸ˜€  Emoji Picker") rofi -show emoji ;;
    "ğŸ“¸  Screen capture") ask_install aserdev-os-utils screenrec && screenrec ;;
    "âŒ  Kill Window") kill_window ;;
    "ğŸ’¬  discord") discord ;;
    "ğŸ§   System Info") sysinfo_menu ;;
    "ğŸ”‹  Power") aser-power;;
    "â„¹ï¸  About") xdg-open "https://github.com/aserdevyt/aserdev-os/" ;;
    *) exit 0 ;;
  esac
}

main_menu
