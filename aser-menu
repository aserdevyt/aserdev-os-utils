#!/usr/bin/env bash
# üß† aserdev's Rofi Control Center ‚Äî Simplified with Screenrec Integration
# Minimal deps: rofi, notify-send, wl-clipboard, a terminal (kitty preferred)
set -euo pipefail
IFS=$'\n\t'

TERMINAL="${TERMINAL:-kitty}"
EDITOR="${EDITOR:-nano}"
ROFI_CMD="${ROFI_CMD:-rofi -dmenu -i -p}"

run_discord() {
  if command -v discord &>/dev/null; then
    discord &
  else
    ask_install discord && discord &
  fi
}

rofi_yn() {
  local prompt="${1:-Proceed?}"
  local ans
  ans=$(printf 'Yes\nNo' | rofi -dmenu -p "$prompt")
  [[ "$ans" == "Yes" ]]
}

ask_install() {
  # Usage: ask_install <package_name> [binary_name]
  local pkg="$1"
  local bin="${2:-$1}"
  if command -v "$bin" &>/dev/null; then
    return 0
  fi

  # Use the binary name in the prompt for clarity, but the package name for installation
  if ! rofi_yn "$bin not found (Part of $pkg). Install $pkg?"; then
    return 1
  fi

  # MODIFIED: Reverting to bash -c and adding || true for robustness
  local install_cmd
  if command -v yay &>/dev/null; then
    # Added || true to prevent set -e crash if installation fails (e.g., cancelled sudo)
    install_cmd="yay -Sy --noconfirm \"$pkg\" || true"
  else
    # Added || true to prevent set -e crash if installation fails
    install_cmd="sudo pacman -Sy --noconfirm \"$pkg\" || true"
  fi

  # MODIFIED: Switched back to 'bash -c'
  $TERMINAL -e bash -c "${install_cmd}; read -p 'Installation complete. Press enter to exit...'"
}

open_in_thunar() {
  local path="${1:-$HOME}"
  if ! command -v thunar &>/dev/null; then
    ask_install thunar || xdg-open "$path" >/dev/null 2>&1 || $TERMINAL -e "$EDITOR" "$path"
  else
    thunar "$path" &
  fi
}

open_file_gui_or_terminal() {
  local file="$1"
  if command -v pluma &>/dev/null; then
    pluma "$file" &
  else
    # MODIFIED: Switched back to 'bash -c'
    $TERMINAL -e bash -c "$EDITOR '$file'; read -p 'Press enter to exit...'"
  fi
}



install_menu() {
  local options=(
    "üèóÔ∏è  AUR (yay)"
    "üì¶  Pacman"
    "üì¶  Flatpak"
    "üîÑ  Update All"
    "‚¨ÖÔ∏è  Back"
  )
  local choice=$(printf '%s\n' "${options[@]}" | rofi -dmenu -i -p "Install")

  case "$choice" in
    # MODIFIED: Switched to bash -c, added || true
    "üèóÔ∏è  AUR (yay)")
        pkg=$(rofi -dmenu -p "AUR package:");
        [[ -n "$pkg" ]] && $TERMINAL -e bash -c "yay -Sy --noconfirm \"$pkg\" || true; read -p 'Press enter to exit...'" ;;

    # MODIFIED: Switched to bash -c, added || true
    "üì¶  Pacman")
        pkg=$(rofi -dmenu -p "Pacman package:");
        [[ -n "$pkg" ]] && $TERMINAL -e bash -c "sudo pacman -Sy --noconfirm \"$pkg\" || true; read -p 'Press enter to exit...'" ;;

    # MODIFIED: Switched to bash -c, added || true
    "üì¶  Flatpak")
        pkg=$(rofi -dmenu -p "Flatpak ID:");
        [[ -n "$pkg" ]] && $TERMINAL -e bash -c "flatpak install -y \"$pkg\" || true; read -p 'Press enter to exit...'" ;;

    # MODIFIED: Switched to bash -c and added || true to all update commands
    "üîÑ  Update All") $TERMINAL -e bash -c 'sudo pacman -Syu --noconfirm || true; flatpak update -y || true; yay -Syu --noconfirm || true; read -p "‚úÖ Done! Press enter..."' ;;
    "‚¨ÖÔ∏è  Back") main_menu ;;
  esac
}

clipboard_menu() {
  local options=("üìã  Open Clipboard" "üßπ  Clear Clipboard" "‚¨ÖÔ∏è  Back")
  local choice=$(printf '%s\n' "${options[@]}" | rofi -dmenu -i -p "Clipboard")
  case "$choice" in
    "üìã  Open Clipboard") ask_install aserdev-os-utils rofi-cliphist && rofi-cliphist ;;
    "üßπ  Clear Clipboard") ask_install aserdev-os-utils cliphist && cliphist wipe && notify-send "Clipboard" "Cleared" || rofi -e "No cliphist" ;;
    "‚¨ÖÔ∏è  Back") main_menu ;;
  esac
}

sysinfo_menu() {
  local options=("üß†  Brokefetch" "‚ö°  Fastfetch" "üìä  Btop" "‚¨ÖÔ∏è  Back")
  local choice=$(printf '%s\n' "${options[@]}" | rofi -dmenu -i -p "System Info")
  case "$choice" in
    # MODIFIED: Switched back to bash -c
    "üß†  Brokefetch")
        command -v brokefetch &>/dev/null && $TERMINAL -e bash -c "brokefetch; read -p 'Press enter to exit...'" || ask_install brokefetch ;;
    # MODIFIED: Switched back to bash -c
    "‚ö°  Fastfetch")
        ask_install fastfetch && $TERMINAL -e bash -c "fastfetch; read -p 'Press enter to exit...'" ;;
    "üìä  Btop")
        # btop is interactive, so it should exit cleanly after the user quits it. No need for a read-p.
        ask_install btop && $TERMINAL -e btop ;;
    "‚¨ÖÔ∏è  Back") main_menu ;;
  esac
}

kill_window() {
  # Use hyprctl to kill the active window for Wayland/Hyprland
  if command -v hyprctl &>/dev/null; then
    hyprctl dispatch killactive ""
  # Fallback to xkill for general X11 environments
  elif command -v xkill &>/dev/null; then
    xkill
    notify-send "Kill Window" "Click the window you want to close."
  else
    rofi -e "No window kill tool (hyprctl or xkill) found."
  fi
}

web_search() {
  local HIST_FILE="$HOME/.cache/web_search_history"
  local ENGINES=(
    "Google|https://www.google.com/search?q="
    "Bing|https://www.bing.com/search?q="
    "DuckDuckGo|https://duckduckgo.com/?q="
    "Wikipedia|https://en.wikipedia.org/wiki/Special:Search?search="
    "ArchWiki|https://wiki.archlinux.org/index.php?search="
  )

  # üß† FIX: Using the jq-based urlencode which is robust, and checking for jq availability.
  if ! command -v jq &>/dev/null; then
    if ! ask_install jq; then
        rofi -e "jq is required for robust URL encoding. Please install it."
        return 1
    fi
  fi
  
  # Robust URL encoding function using jq
  urlencode() {
    jq -rn --arg v "$1" '$v|@uri'
  }

  # pick engine üß†
  local engine_choice engine_name engine_url
  engine_choice=$(printf "%s\n" "${ENGINES[@]%%|*}" | rofi -dmenu -p "üåê Choose engine:")
  [[ -z "$engine_choice" ]] && return

  for e in "${ENGINES[@]}"; do
    engine_name="${e%%|*}"
    engine_url="${e#*|}"
    [[ "$engine_name" == "$engine_choice" ]] && break
  done

  # search query (with history üß†)
  mkdir -p "$(dirname "$HIST_FILE")"
  touch "$HIST_FILE"
  local query
  query=$(tac "$HIST_FILE" | rofi -dmenu -p "üîé Search:" -mesg "Engine: $engine_name (Enter to search, Esc to cancel)")
  [[ -z "$query" ]] && return

  # save to history (no dupes)
  grep -Fxq "$query" "$HIST_FILE" || echo "$query" >> "$HIST_FILE"

  # encode + open üåç
  local encoded_query
  encoded_query=$(urlencode "$query")
  xdg-open "${engine_url}${encoded_query}" &>/dev/null &
}



swaync_client() {
  # Sway Notification Center client to toggle the notification list
  # Package name is typically 'swaync' but the binary is 'swaync-client'
  ask_install swaync swaync-client && swaync-client -t
}

main_menu() {
  local options=(
    "‚öôÔ∏è  Settings"
    "üöÄ  Run Command"
    "üåê  Web Search"
    "üîî  Notifications"
    "üì¶  Install"
    "üìã  Clipboard"
    "üòÄ  Emoji Picker"
    "üì∏  Screen capture"
    "‚ùå  Kill Window"
    "üí¨  discord"
    "üß†  System Info"
    "üîã  Power"
    "‚ÑπÔ∏è  About"
  )
  local choice=$(printf '%s\n' "${options[@]}" | rofi -dmenu -i -p "Aser Control Center")
  case "$choice" in
    "‚öôÔ∏è  Settings") aser-settings ;;
    "üöÄ  Run Command") rofi -show run ;;
    "üåê  Web Search") web_search ;;
    "üîî  Notifications") swaync_client ;;
    "üì¶  Install") install_menu ;;
    "üìã  Clipboard") clipboard_menu ;;
    "üòÄ  Emoji Picker") rofi -show emoji ;;
    "üì∏  Screen capture") ask_install aserdev-os-utils screenrec && screenrec ;;
    "‚ùå  Kill Window") kill_window ;;
    "üí¨  discord") discord ;;
    "üß†  System Info") sysinfo_menu ;;
    "üîã  Power") command -v wlogout &>/dev/null && wlogout || rofi -e "wlogout not installed" ;;
    "‚ÑπÔ∏è  About") xdg-open "https://github.com/aserdevyt/aserdev-os/" ;;
    *) exit 0 ;;
  esac
}

main_menu
