#!/usr/bin/bash

# COLORS ðŸ˜­ðŸ”¥ (yes I'm using colors, fight me)
RED="\e[31m"
GREEN="\e[32m"
YELLOW="\e[33m"
BLUE="\e[34m"
MAGENTA="\e[35m"
CYAN="\e[36m"
RESET="\e[0m"

# detect UTF-8 / Unicode support and fall back to ASCII when missing
if locale charmap 2>/dev/null | grep -qi utf-8; then
    ICON_INFO='â„¹'
    ICON_STEP='âžœ'
    ICON_SUCCESS='âœ”'
    ICON_FAIL='âœ–'
else
    ICON_INFO='i'
    ICON_STEP='->'
    ICON_SUCCESS='OK'
    ICON_FAIL='!!'
fi

# simple banner and helper printers (match `ins` style)
banner() {
    local title="$1"
    printf "%b\n" "${MAGENTA}========================================${RESET}"
    printf "%b\n" "${CYAN}${title}${RESET}"
    printf "%b\n" "${MAGENTA}========================================${RESET}"
}

info() { printf "%b\n" "${CYAN}${ICON_INFO} ${RESET}$*"; }
step() { printf "%b\n" "${YELLOW}${ICON_STEP} ${RESET}$*"; }
success() { printf "%b\n" "${GREEN}${ICON_SUCCESS} ${RESET}$*"; }
fail() { printf "%b\n" "${RED}${ICON_FAIL} ${RESET}$*"; }

# check that a command exists and can be executed (not just present on PATH)
command_works() {
    local cmd="$1"
    if ! command -v "$cmd" >/dev/null 2>&1; then
        return 1
    fi
    if "$cmd" --version >/dev/null 2>&1; then
        return 0
    else
        fail "$cmd exists but failed to run (skipping)"
        return 1
    fi
}

# ðŸ§  Welcome to the Update Scriptâ„¢
# This thing will update your system whether it's ready or not.
# pray.

banner "Update Script"

step "Checking if pacman is being held hostage..."

# check pacman lock
if [ -f /var/lib/pacman/db.lck ]; then
    fail "BRO WHAT ARE YOU DOING??"
    info "Pacman is literally locked rn."
    info "Someone (probably you) left it running."

    read -p "$(echo -e "${MAGENTA}Wanna risk it anyway? (y/n): ${RESET}")" choice

    if [[ "$choice" != "y" && "$choice" != "Y" ]]; then
        fail "coward. exiting..."
        exit 1
    else
        step "Removing the lock like an absolute menace..."
        sudo rm /var/lib/pacman/db.lck
    fi
fi

step "Starting updates... hold onto your RAM..."
sleep 2
if ! sudo pacman -Syu --noconfirm; then
    fail "Pacman said 'nah' and dipped"
    exit 1
fi

success "pacman is done bullying your system."
info "Looking for AUR and Flatpak updates like Dora the Explorer..."
sleep 2

step "Installing other updates (AUR / Flatpak)"
sleep 1

# AUR updates: try yay, then paru fallback
if command -v yay >/dev/null 2>&1; then
    step "Updating AUR with yay..."
    sleep 1
    if ! yay -Syu --noconfirm; then
        fail "yay exploded â€” attempting paru fallback..."
        if command -v paru >/dev/null 2>&1; then
            step "Updating AUR with paru..."
            paru -Syu --noconfirm || fail "paru exploded as well"
        else
            fail "paru not found â€” AUR updates skipped"
        fi
    fi
elif command -v paru >/dev/null 2>&1; then
    step "yay not found; updating AUR with paru..."
    paru -Syu --noconfirm || fail "paru exploded"
else
    fail "no yay or paru found â€” skipping AUR updates"
fi

# flatpak updates
if command -v flatpak &> /dev/null; then
    step "Updating Flatpak apps (yes, even the ones you forgot exist)..."
    sleep 1
    if flatpak update -y; then
        success "flatpak updates applied"
    else
        fail "flatpak update failed"
    fi
else
    info "flatpak not found â€” skipping"
fi

success "Everything is updated, your system is now 0.003% faster."
info "You may now go back to wasting RAM on Electron apps."

exit 0
