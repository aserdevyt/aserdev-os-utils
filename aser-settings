#!/usr/bin/env bash
# ğŸ§  aserdev's Rofi Control Center â€” Simplified with Screenrec Integration
# Minimal deps: rofi, notify-send, wl-clipboard, a terminal (kitty preferred)
set -euo pipefail
IFS=$'\n\t'

TERMINAL="${TERMINAL:-kitty}"
EDITOR="${EDITOR:-nano}"
ROFI_CMD="${ROFI_CMD:-rofi -dmenu -i -p}"

rofi_yn() {
  local prompt="${1:-Proceed?}"
  local ans
  ans=$(printf 'Yes\nNo' | rofi -dmenu -p "$prompt")
  [[ "$ans" == "Yes" ]]
}

ask_install() {
  # Usage: ask_install <package_name> [binary_name]
  local pkg="$1"
  local bin="${2:-$1}"
  if command -v "$bin" &>/dev/null; then
    return 0
  fi

  # Use the binary name in the prompt for clarity, but the package name for installation
  if ! rofi_yn "$bin not found (Part of $pkg). Install $pkg?"; then
    return 1
  fi

  # MODIFIED: Reverting to bash -c and adding || true for robustness
  local install_cmd
  if command -v yay &>/dev/null; then
    # Added || true to prevent set -e crash if installation fails (e.g., cancelled sudo)
    install_cmd="yay -S --noconfirm \"$pkg\" || true"
  else
    # Added || true to prevent set -e crash if installation fails
    install_cmd="sudo pacman -S --noconfirm \"$pkg\" || true"
  fi

  # MODIFIED: Switched back to 'bash -c'
  $TERMINAL -e bash -c "${install_cmd}; read -p 'Installation complete. Press enter to exit...'"
}

open_in_thunar() {
  local path="${1:-$HOME}"
  if ! command -v thunar &>/dev/null; then
    ask_install thunar || xdg-open "$path" >/dev/null 2>&1 || $TERMINAL -e "$EDITOR" "$path"
  else
    thunar "$path" &
  fi
}

open_file_gui_or_terminal() {
  local file="$1"
  if command -v pluma &>/dev/null; then
    pluma "$file" &
  else
    # MODIFIED: Switched back to 'bash -c'
    $TERMINAL -e bash -c "$EDITOR '$file'; read -p 'Press enter to exit...'"
  fi
}

settings_menu() {
  local options=(
    "ğŸŒ€  Hyprland"
    "ğŸ§­  Waybar"
    "ğŸ›ï¸  Rofi"
    "ğŸ–¼ï¸  Wallpaper"
    "âŒ¨ï¸  Keybinds"
    "ğŸ¨  Color Picker"
    "ğŸ”Š  Audio Settings"
    "ğŸ‘¤  Users"
    "ğŸ’½  Disk Management" # <-- Added Disk Management
    "ğŸ—‚ï¸  All Settings"
    "â¬…ï¸  Back"
  )
  local choice=$(printf '%s\n' "${options[@]}" | rofi -dmenu -i -p "Settings")

  case "$choice" in
    "ğŸŒ€  Hyprland") open_in_thunar "$HOME/.config/hypr" ;;
    "ğŸ§­  Waybar") open_in_thunar "$HOME/.config/waybar" ;;
    "ğŸ›ï¸  Rofi") open_in_thunar "$HOME/.config/rofi" ;;
    "ğŸ–¼ï¸  Wallpaper") if command -v waypaper &>/dev/null; then waypaper & else ask_install waypaper || rofi -e "No wallpaper tool found"; fi ;;
    "âŒ¨ï¸  Keybinds") [[ -f ~/.config/hypr/binds.conf ]] && open_file_gui_or_terminal "$HOME/.config/hypr/binds.conf" || rofi -e "binds.conf not found ğŸ’€" ;;
    "ğŸ¨  Color Picker") ask_install hyprpicker || return; color=$(hyprpicker -a 2>/dev/null || true); [[ -n "$color" ]] && wl-copy "$color" && notify-send "Color" "Copied: $color" || rofi -e "No color picked ğŸ’€" ;;
    "ğŸ”Š  Audio Settings") ask_install pavucontrol && pavucontrol & ;;
    "ğŸ‘¤  Users") ask_install userctl && $TERMINAL -e sudo userctl ;;
    "ğŸ’½  Disk Management") ask_install gnome-disk-utility gnome-disks && gnome-disks & ;; # <-- Runs gnome-disks
    "ğŸ—‚ï¸  All Settings") open_in_thunar "$HOME/.config" ;;
    "â¬…ï¸  Back") main_menu ;;
  esac
}

install_menu() {
  local options=(
    "ğŸ—ï¸  AUR (yay)"
    "ğŸ“¦  Pacman"
    "ğŸ“¦  Flatpak"
    "ğŸ”„  Update All"
    "â¬…ï¸  Back"
  )
  local choice=$(printf '%s\n' "${options[@]}" | rofi -dmenu -i -p "Install")

  case "$choice" in
    # MODIFIED: Switched to bash -c, added || true
    "ğŸ—ï¸  AUR (yay)")
        pkg=$(rofi -dmenu -p "AUR package:");
        [[ -n "$pkg" ]] && $TERMINAL -e bash -c "yay -S --noconfirm \"$pkg\" || true; read -p 'Press enter to exit...'" ;;

    # MODIFIED: Switched to bash -c, added || true
    "ğŸ“¦  Pacman")
        pkg=$(rofi -dmenu -p "Pacman package:");
        [[ -n "$pkg" ]] && $TERMINAL -e bash -c "sudo pacman -S --noconfirm \"$pkg\" || true; read -p 'Press enter to exit...'" ;;

    # MODIFIED: Switched to bash -c, added || true
    "ğŸ“¦  Flatpak")
        pkg=$(rofi -dmenu -p "Flatpak ID:");
        [[ -n "$pkg" ]] && $TERMINAL -e bash -c "flatpak install -y \"$pkg\" || true; read -p 'Press enter to exit...'" ;;

    # MODIFIED: Switched to bash -c and added || true to all update commands
    "ğŸ”„  Update All") $TERMINAL -e bash -c 'sudo pacman -Syu --noconfirm || true; flatpak update -y || true; yay -Syu --noconfirm || true; read -p "âœ… Done! Press enter..."' ;;
    "â¬…ï¸  Back") main_menu ;;
  esac
}

clipboard_menu() {
  local options=("ğŸ“‹  Open Clipboard" "ğŸ§¹  Clear Clipboard" "â¬…ï¸  Back")
  local choice=$(printf '%s\n' "${options[@]}" | rofi -dmenu -i -p "Clipboard")
  case "$choice" in
    "ğŸ“‹  Open Clipboard") ask_install aserdev-os-utils rofi-cliphist && rofi-cliphist ;;
    "ğŸ§¹  Clear Clipboard") ask_install aserdev-os-utils cliphist && cliphist wipe && notify-send "Clipboard" "Cleared" || rofi -e "No cliphist" ;;
    "â¬…ï¸  Back") main_menu ;;
  esac
}

sysinfo_menu() {
  local options=("ğŸ§   Brokefetch" "âš¡  Fastfetch" "ğŸ“Š  Btop" "â¬…ï¸  Back")
  local choice=$(printf '%s\n' "${options[@]}" | rofi -dmenu -i -p "System Info")
  case "$choice" in
    # MODIFIED: Switched back to bash -c
    "ğŸ§   Brokefetch")
        command -v brokefetch &>/dev/null && $TERMINAL -e bash -c "brokefetch; read -p 'Press enter to exit...'" || ask_install brokefetch ;;
    # MODIFIED: Switched back to bash -c
    "âš¡  Fastfetch")
        ask_install fastfetch && $TERMINAL -e bash -c "fastfetch; read -p 'Press enter to exit...'" ;;
    "ğŸ“Š  Btop")
        # btop is interactive, so it should exit cleanly after the user quits it. No need for a read-p.
        ask_install btop && $TERMINAL -e btop ;;
    "â¬…ï¸  Back") main_menu ;;
  esac
}

kill_window() {
  # Use hyprctl to kill the active window for Wayland/Hyprland
  if command -v hyprctl &>/dev/null; then
    hyprctl dispatch killactive ""
  # Fallback to xkill for general X11 environments
  elif command -v xkill &>/dev/null; then
    xkill
    notify-send "Kill Window" "Click the window you want to close."
  else
    rofi -e "No window kill tool (hyprctl or xkill) found."
  fi
}

# Basic URL encoding (replace spaces with + for browser compatibility)
urlencode() {
  echo "$1" | sed 's/ /+/g'
}

web_search() {
  local query
  query=$(rofi -dmenu -p "ğŸŒ Web Search:")
  if [[ -n "$query" ]]; then
    local encoded_query
    encoded_query=$(urlencode "$query")
    # Use xdg-open to launch the default browser with a Google search
    xdg-open "https://www.google.com/search?q=$encoded_query" &>/dev/null &
  fi
}

swaync_client() {
  # Sway Notification Center client to toggle the notification list
  # Package name is typically 'swaync' but the binary is 'swaync-client'
  ask_install swaync swaync-client && swaync-client -t
}

unmount_device_menu() {
  # Use findmnt to list mounted paths that are NOT the root, boot, or special filesystems, 
  # focusing on removable devices likely mounted by the user.
  local options
  # Get TARGET and SOURCE, format them nicely, and filter out system paths
  options=$(findmnt -lnr -o TARGET,SOURCE -t nosquashfs,nofs,nosysfs,noproc,nodevtmpfs | grep -v '^/dev\|^/boot\|^/sys\|^/proc\|^/run\|^/var' | sed 's/ / | /' )

  if [[ -z "$options" ]]; then
    rofi -e "No removable devices currently mounted."
    return
  fi

  local choice
  choice=$(printf '%s\n' "${options[@]}" | rofi -dmenu -i -p "Unmount Device")

  if [[ -n "$choice" ]]; then
    # Extract the mount point (TARGET) which is the first field before the separator ' | '
    local mount_point
    mount_point=$(echo "$choice" | awk -F ' | ' '{print $1}')

    # Execute umount in a terminal, requiring sudo
    rofi_yn "Unmount '$mount_point'? (Requires sudo)" && \
    $TERMINAL -e bash -c "sudo umount \"$mount_point\"; read -p 'Unmount complete. Press enter...'"
  fi
}

main_menu() {
  local options=(
    "âš™ï¸  Settings"
    "ğŸš€  Run Command"
    "ğŸŒ  Web Search"
    "ğŸ””  Notifications"
    "ğŸ—„ï¸  Unmount Device"
    "ğŸ“¦  Install"
    "ğŸ“‹  Clipboard"
    "ğŸ˜€  Emoji Picker"
    "ğŸ“¸  Screen Recording"
    "âŒ  Kill Window"
    "ğŸ§   System Info"
    "ğŸ”‹  Power"
    "â„¹ï¸  About"
  )
  local choice=$(printf '%s\n' "${options[@]}" | rofi -dmenu -i -p "Aser Control Center")
  case "$choice" in
    "âš™ï¸  Settings") settings_menu ;;
    "ğŸš€  Run Command") rofi -show run ;;
    "ğŸŒ  Web Search") web_search ;;
    "ğŸ””  Notifications") swaync_client ;;
    "ğŸ—„ï¸  Unmount Device") unmount_device_menu ;;
    "ğŸ“¦  Install") install_menu ;;
    "ğŸ“‹  Clipboard") clipboard_menu ;;
    "ğŸ˜€  Emoji Picker") rofi -show emoji ;;

    # screenrec runs in the background
    "ğŸ“¸  Screen Recording") ask_install aserdev-os-utils screenrec && screenrec & ;;

    "âŒ  Kill Window") kill_window ;;

    "ğŸ§   System Info") sysinfo_menu ;;
    "ğŸ”‹  Power") command -v wlogout &>/dev/null && wlogout || rofi -e "wlogout not installed" ;;
    "â„¹ï¸  About") xdg-open "https://github.com/aserdevyt/aserdev-os/" ;;
    *) exit 0 ;;
  esac
}

main_menu
