#!/bin/bash

# --- Configuration ---
# default shell for the homies (and the ops)
DEFAULT_SHELL="/bin/zsh"
# place where skeleton configs rot
SKEL_DIR="/etc/skel"

# --- Safety Checks ---

# Check if mf is NOT root
if [ "$(id -u)" -ne 0 ]; then
   echo "Bro... you ain't root. Trying sudo before I start yelling..."
   exec sudo "$0" "$@"

   echo "Sudo said NO ðŸ’€ skill issue."
   exit 1
fi

# Check for dialog
if ! command -v dialog &> /dev/null; then
    echo "WHERE tf is 'dialog'??" >&2
    echo "Install it pls. I'm not doing TUI UI by hand." >&2
    exit 1
fi

# --- Functions ---

# find out what clown group your system uses
get_sudo_group() {
    if grep -q '^sudo:' /etc/group; then
        echo "sudo"
    elif grep -q '^wheel:' /etc/group; then
        echo "wheel"
    else
        echo "" # how are you even running linux bro
    fi
}

# spawn a new human from the void
add_user() {
    local username password

    username=$(dialog --inputbox "Gimme the username (no goofy names pls):" 8 40 2>&1 >/dev/tty)
    if [ -z "$username" ]; then
        dialog --msgbox "Bro cancelled adding a user ðŸ’€" 5 40
        return 1
    fi

    password=$(dialog --passwordbox "Enter password for $username (don't make it '123'):" 8 40 2>&1 >/dev/tty)
    if [ -z "$password" ]; then
        dialog --msgbox "You refused to set a password... ok coward." 6 40
        return 1
    fi

    if id -u "$username" &>/dev/null; then
        dialog --msgbox "HELLO?? '$username' already exists you donut." 6 40
        return 1
    fi

    # create the creature
    useradd -m -s "$DEFAULT_SHELL" "$username"

    if [ $? -eq 0 ]; then
        echo "$username:$password" | chpasswd
        if [ $? -eq 0 ]; then
            local sudo_message="User '$username' created successfully. W."

            dialog --yesno "Make '$username' a sudo warrior?" 7 45
            if [ $? -eq 0 ]; then

                local sudo_group=$(get_sudo_group)
                if [ -n "$sudo_group" ]; then
                    usermod -aG "$sudo_group" "$username"
                    sudo_message+="\nAdded to '$sudo_group'. Absolute power."

                    dialog --yesno "Wanna enable passwordless sudo? (dangerous as hell btw)" 8 60
                    if [ $? -eq 0 ]; then
                        local sudoer_file="/etc/sudoers.d/$username"
                        echo "$username ALL=(ALL) NOPASSWD: ALL" > "$sudoer_file"
                        chmod 0440 "$sudoer_file"
                        sudo_message+="\nPasswordless sudo enabled. God mode unlocked."
                    else
                        sudo_message+="\nPasswordless sudo declined. Coward."
                    fi
                else
                    sudo_message+="\nCouldn't find sudo/wheel. What distro **IS** this?"
                fi
            fi

            dialog --msgbox "$sudo_message" 12 60
        else
            dialog --msgbox "User '$username' created but password FAILED ðŸ’€ðŸ’€" 6 50
        fi
    else
        dialog --msgbox "Couldn't create '$username'. L script? L user? idk." 6 50
    fi
}

# delete a whole human being
delete_user() {
    local username

    username=$(dialog --inputbox "Who we deleting today? âš°ï¸" 8 40 2>&1 >/dev/tty)
    if [ -z "$username" ]; then
        dialog --msgbox "Aight no murder today." 5 30
        return 1
    fi

    if [ "$username" = "root" ]; then
        dialog --msgbox "Delete ROOT??? nah bro you smoking." 6 50
        return 1
    fi

    if ! id -u "$username" &>/dev/null; then
        dialog --msgbox "User '$username' does NOT exist bruv ðŸ’€" 6 40
        return 1
    fi

    dialog --yesno "You SURE you wanna delete '$username'? This ain't undoable." 8 60
    if [ $? -eq 0 ]; then
        userdel -r "$username"
        if [ $? -eq 0 ]; then
            local sudoer_file="/etc/sudoers.d/$username"
            [ -f "$sudoer_file" ] && rm -f "$sudoer_file"

            dialog --msgbox "'$username' deleted. Gone. Reduced to atoms." 6 50
        else
            dialog --msgbox "Couldn't delete '$username'. Maybe he's logged in gaming." 7 50
        fi
    else
        dialog --msgbox "No deletion. Coward." 5 30
    fi
}

# change someone's password bc they forgot it like a clown
change_password() {
    local username password

    username=$(dialog --inputbox "Whose password we resetting?" 8 40 2>&1 >/dev/tty)
    if [ -z "$username" ]; then
        dialog --msgbox "No user selected, mission aborted." 5 30
        return 1
    fi

    if ! id -u "$username" &>/dev/null; then
        dialog --msgbox "User '$username' doesn't exist. Try someone REAL." 6 40
        return 1
    fi

    password=$(dialog --passwordbox "New password for $username:" 8 40 2>&1 >/dev/tty)
    if [ -z "$password" ]; then
        dialog --msgbox "Password empty? nah bro." 6 30
        return 1
    fi

    echo "$username:$password" | chpasswd
    if [ $? -eq 0 ]; then
        dialog --msgbox "Password changed. Don't leak it on Discord." 6 40
    else
        dialog --msgbox "Password change FAILED. How do you fail THIS??" 6 40
    fi
}

# --- Main Loop of Doom ---

while true; do
    CHOICE=$(dialog --clear --backtitle "User Manager 3000" \
                    --title "Main Menu" \
                    --menu "Pick your nonsense:" 15 50 4 \
                    1 "Add User (spawn NPC)" \
                    2 "Delete User (Thanos snap)" \
                    3 "Change Password (bc someone forgot again)" \
                    4 "Exit (rage quit)" \
                    2>&1 >/dev/tty)

    status=$?
    if [ $status -ne 0 ]; then
        clear
        echo "Aight we out."
        exit 0
    fi

    case $CHOICE in
        1) add_user ;;
        2) delete_user ;;
        3) change_password ;;
        4)
            clear
            echo "Bye bozo ðŸ’€"
            exit 0
            ;;
    esac
done
